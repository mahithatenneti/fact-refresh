name: Temporary Flask + Ngrok Test

on:
  workflow_dispatch: {}

jobs:
  serve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt flask pyngrok

      - name: Start Flask + Ngrok
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_DATASET_ID: mahi1010/news_articles_daily_m
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          nohup python api/app.py >/dev/null 2>&1 &
          sleep 8
          python -c "from pyngrok import ngrok; import time, os; ngrok.set_auth_token(os.environ['NGROK_AUTH_TOKEN']); t=ngrok.connect(8000,'http'); print('PUBLIC_URL=' + t.public_url, flush=True); time.sleep(600)"
